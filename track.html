<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Soccer Stats Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .scrollable-table {
            max-height: 65vh;
            overflow-y: auto;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-4 md:p-8">

        <!-- Header -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-gray-900 flex items-center">
                <i data-lucide="goal" class="w-8 h-8 mr-3 text-red-600"></i>
                Collaborative Soccer Stats
            </h1>
            <p class="text-sm text-gray-500 mt-1">Real-time player tracking. Data is public and shared with all users.</p>
            <p id="auth-status" class="text-xs mt-2 p-1 bg-gray-100 rounded-md text-gray-600"></p>
        </header>

        <!-- Loading & Error Messages -->
        <div id="loading" class="text-center p-12 text-blue-600 font-semibold hidden">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading and signing in...
        </div>
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Error:</strong>
            <span id="error-text" class="block sm:inline"></span>
        </div>

        <!-- Add New Player Form -->
        <section class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <i data-lucide="user-plus" class="w-5 h-5 mr-2 text-green-600"></i>
                Add New Player Stats
            </h2>
            <form id="add-player-form" class="grid grid-cols-2 md:grid-cols-6 gap-4">
                <input type="text" id="name" placeholder="Player Name" required class="col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                <select id="position" required class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    <option value="" disabled selected>Position</option>
                    <option value="Forward">Forward</option>
                    <option value="Midfielder">Midfielder</option>
                    <option value="Defender">Defender</option>
                    <option value="Goalkeeper">Goalkeeper</option>
                </select>
                <input type="number" id="goals" placeholder="Goals (0)" min="0" value="0" required class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                <input type="number" id="assists" placeholder="Assists (0)" min="0" value="0" required class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                <input type="number" id="games" placeholder="Games (0)" min="0" value="0" required class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                <button type="submit" class="col-span-2 md:col-span-6 bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition duration-150 shadow-md">
                    <i data-lucide="save" class="w-5 h-5 inline mr-2"></i>
                    Save Player
                </button>
            </form>
        </section>

        <!-- Stats Table -->
        <section>
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-blue-600"></i>
                Current Player Roster
            </h2>
            <div class="scrollable-table shadow-lg ring-1 ring-black ring-opacity-5">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-600 sticky top-0 z-10 shadow-md">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider md:px-6">Player Name</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-white uppercase tracking-wider md:px-6">Position</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-white uppercase tracking-wider md:px-6">Goals</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-white uppercase tracking-wider md:px-6">Assists</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-white uppercase tracking-wider md:px-6">Games</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-white uppercase tracking-wider md:px-6">Added By</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-white uppercase tracking-wider md:px-6">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Player rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <p id="no-data-message" class="p-6 text-center text-gray-500 bg-white rounded-b-lg hidden">No player stats have been added yet.</p>
        </section>
    </div>

    <!-- Confirmation Modal Structure (Hidden by default) -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96 max-w-sm transform transition-all duration-300 scale-100">
            <h3 class="text-xl font-bold mb-4 text-red-600">Confirm Deletion</h3>
            <p class="mb-6 text-gray-700">Are you sure you want to delete <strong id="player-to-delete-name"></strong>'s stats?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal Structure (Hidden by default) -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3 max-w-lg transform transition-all duration-300 scale-100">
            <h3 class="text-xl font-bold mb-4 text-blue-600 flex items-center">
                <i data-lucide="pencil" class="w-5 h-5 mr-2"></i>
                Edit Player Stats: <span id="player-to-edit-name" class="ml-2 text-gray-800"></span>
            </h3>
            <form id="edit-player-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div>
                    <label for="edit-position" class="block text-sm font-medium text-gray-700">Position</label>
                    <select id="edit-position" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="Forward">Forward</option>
                        <option value="Midfielder">Midfielder</option>
                        <option value="Defender">Defender</option>
                        <option value="Goalkeeper">Goalkeeper</option>
                    </select>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="edit-goals" class="block text-sm font-medium text-gray-700">Goals</label>
                        <input type="number" id="edit-goals" min="0" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="edit-assists" class="block text-sm font-medium text-gray-700">Assists</label>
                        <input type="number" id="edit-assists" min="0" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="edit-games" class="block text-sm font-medium text-gray-700">Games Played</label>
                        <input type="number" id="edit-games" min="0" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-edit" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition shadow-md">
                        <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>
                        Update Stats
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase setup and main application logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
        
        // Use debug logging for development
        setLogLevel('debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- DOM Elements ---
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error-message');
        const errorTextElement = document.getElementById('error-text');
        const authStatusElement = document.getElementById('auth-status');
        const addForm = document.getElementById('add-player-form');
        const statsTableBody = document.getElementById('stats-table-body');
        const noDataMessage = document.getElementById('no-data-message');
        
        // Delete Modal Elements
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete');
        const cancelDeleteButton = document.getElementById('cancel-delete');
        const playerToDeleteText = document.getElementById('player-to-delete-name');

        // Edit Modal Elements
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-player-form');
        const cancelEditButton = document.getElementById('cancel-edit');
        const playerToEditName = document.getElementById('player-to-edit-name');
        const editIdInput = document.getElementById('edit-id');
        const editPositionInput = document.getElementById('edit-position');
        const editGoalsInput = document.getElementById('edit-goals');
        const editAssistsInput = document.getElementById('edit-assists');
        const editGamesInput = document.getElementById('edit-games');


        // --- Firebase Instances & State ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let playersData = {}; // Cache player data for quick access during edit

        // State for moddals
        let docIdToDelete = null;

        // --- Utility Functions ---

        const MAX_RETRIES = 5;
        const INITIAL_DELAY = 1000;

        async function runWithRetry(operation, operationName) {
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    return await operation();
                } catch (e) {
                    if (e.code === 'unavailable' || e.code === 'internal') {
                        const delay = INITIAL_DELAY * Math.pow(2, i) + Math.random() * INITIAL_DELAY;
                        console.warn(`${operationName} failed. Retrying in ${delay}ms... (Attempt ${i + 1}/${MAX_RETRIES})`, e);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw e;
                    }
                }
            }
            throw new Error(`Failed to complete ${operationName} after ${MAX_RETRIES} attempts.`);
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            loadingElement.classList.remove('hidden');
            errorElement.classList.add('hidden');
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                let authPromise;
                if (authToken) {
                    authPromise = signInWithCustomToken(auth, authToken);
                } else {
                    authPromise = signInAnonymously(auth);
                }

                await runWithRetry(() => authPromise, 'Firebase Sign-In');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.innerHTML = `<i data-lucide="shield-check" class="w-4 h-4 inline mr-1 text-green-500"></i> Signed in. Your User ID: <span class="font-mono text-gray-800">${userId}</span>`;
                    } else {
                        userId = null;
                        authStatusElement.innerHTML = `<i data-lucide="shield-off" class="w-4 h-4 inline mr-1 text-red-500"></i> Not authenticated. Using anonymous mode.`;
                    }
                    isAuthReady = true;
                    loadingElement.classList.add('hidden');
                    lucide.createIcons();
                    
                    if (db && userId) {
                        setupRealtimeListener();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingElement.classList.add('hidden');
                errorTextElement.textContent = `Failed to initialize application. ${error.message}`;
                errorElement.classList.remove('hidden');
                lucide.createIcons();
            }
        }
        
        /**
         * Sets up the real-time listener for the soccer stats collection.
         */
        function setupRealtimeListener() {
            if (!db || !isAuthReady) return;

            const collectionPath = `artifacts/${appId}/public/data/soccer_stats`;
            const statsQuery = query(collection(db, collectionPath));
            
            runWithRetry(() => new Promise((resolve, reject) => {
                const unsubscribe = onSnapshot(statsQuery, (snapshot) => {
                    renderStatsTable(snapshot.docs);
                    resolve(unsubscribe);
                }, (error) => {
                    console.error("Error listening to Firestore:", error);
                    errorTextElement.textContent = `Failed to fetch real-time stats. ${error.message}`;
                    errorElement.classList.remove('hidden');
                    reject(error);
                });
            }), 'Firestore onSnapshot');
        }

        /**
         * Renders the player stats table from the Firestore documents.
         */
        function renderStatsTable(docs) {
            // Map and cache data
            playersData = {};
            const stats = docs.map(doc => {
                const data = { id: doc.id, ...doc.data() };
                playersData[doc.id] = data; // Cache the data
                return data;
            });
            
            // Sort by Goals (descending) and then Assists (descending)
            stats.sort((a, b) => {
                if (b.goals !== a.goals) return b.goals - a.goals;
                return b.assists - a.assists;
            });

            statsTableBody.innerHTML = '';

            if (stats.length === 0) {
                noDataMessage.classList.remove('hidden');
            } else {
                noDataMessage.classList.add('hidden');
            }

            stats.forEach(player => {
                const isOwner = player.userId === userId;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                
                const addedByDisplay = player.userId ? `${player.userId.substring(0, 4)}...` : 'Unknown';

                row.innerHTML = `
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.name}</td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap text-sm text-gray-700">${player.position}</td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap text-sm text-center font-bold text-red-600">${player.goals}</td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap text-sm text-center font-bold text-blue-600">${player.assists}</td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${player.games}</td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap text-xs text-gray-400">
                        <span title="Added by full ID: ${player.userId || 'Unknown'}">${addedByDisplay}</span>
                    </td>
                    <td class="px-3 md:px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2 flex justify-end">
                        <button data-id="${player.id}" data-name="${player.name}" class="edit-btn text-blue-500 hover:text-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed" title="Edit Entry" ${isOwner ? '' : 'disabled'}>
                            <i data-lucide="pencil" class="w-5 h-5"></i>
                        </button>
                        <button data-id="${player.id}" data-name="${player.name}" class="delete-btn text-red-500 hover:text-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed" title="Delete Entry" ${isOwner ? '' : 'disabled'}>
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </td>
                `;
                statsTableBody.appendChild(row);
            });
            
            // Re-run icon rendering for dynamically added content
            lucide.createIcons();
            
            // Attach event listeners to new buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteClick);
            });
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditClick);
            });
        }

        // --- CRUD Handlers ---

        // Add Player
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !userId) {
                console.error("Database not initialized or user not signed in.");
                return;
            }

            const nameInput = document.getElementById('name');
            const positionInput = document.getElementById('position');
            const goalsInput = document.getElementById('goals');
            const assistsInput = document.getElementById('assists');
            const gamesInput = document.getElementById('games');

            const newPlayer = {
                name: nameInput.value.trim(),
                position: positionInput.value,
                goals: parseInt(goalsInput.value, 10) || 0,
                assists: parseInt(assistsInput.value, 10) || 0,
                games: parseInt(gamesInput.value, 10) || 0,
                userId: userId,
                createdAt: new Date().toISOString(),
            };

            const collectionPath = `artifacts/${appId}/public/data/soccer_stats`;

            try {
                await runWithRetry(() => addDoc(collection(db, collectionPath), newPlayer), 'Add Player Stat');
                addForm.reset();
                positionInput.value = "";
                goalsInput.value = "0";
                assistsInput.value = "0";
                gamesInput.value = "0";
            } catch (error) {
                console.error("Error adding player stats:", error);
                errorTextElement.textContent = `Failed to add player stats. ${error.message}`;
                errorElement.classList.remove('hidden');
            }
        });

        // Delete Player - Show Modal
        function handleDeleteClick(e) {
            const button = e.currentTarget;
            docIdToDelete = button.getAttribute('data-id');
            const playerName = button.getAttribute('data-name');
            playerToDeleteText.textContent = playerName;
            deleteModal.classList.remove('hidden');
        }

        // Delete Player - Confirm
        confirmDeleteButton.addEventListener('click', async () => {
            if (!docIdToDelete || !db) {
                deleteModal.classList.add('hidden');
                return;
            }

            const docPath = `artifacts/${appId}/public/data/soccer_stats/${docIdToDelete}`;
            
            try {
                await runWithRetry(() => deleteDoc(doc(db, docPath)), 'Delete Player Stat');
                console.log("Document successfully deleted!");
            } catch (error) {
                console.error("Error deleting document:", error);
                errorTextElement.textContent = `Failed to delete player stats. ${error.message}`;
                errorElement.classList.remove('hidden');
            } finally {
                docIdToDelete = null;
                deleteModal.classList.add('hidden');
            }
        });
        cancelDeleteButton.addEventListener('click', () => {
            docIdToDelete = null;
            deleteModal.classList.add('hidden');
        });

        // Edit Player - Show Modal and Pre-fill
        function handleEditClick(e) {
            const docId = e.currentTarget.getAttribute('data-id');
            const player = playersData[docId];

            if (!player) {
                console.error("Player data not found for editing.");
                return;
            }
            
            playerToEditName.textContent = player.name;
            editIdInput.value = docId;
            editPositionInput.value = player.position;
            editGoalsInput.value = player.goals;
            editAssistsInput.value = player.assists;
            editGamesInput.value = player.games;

            editModal.classList.remove('hidden');
            lucide.createIcons(); // Re-render icons in modal
        }

        // Edit Player - Cancel
        cancelEditButton.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        // Edit Player - Update Firestore
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const docId = editIdInput.value;
            if (!docId || !db) {
                console.error("Cannot update. Document ID missing or DB not ready.");
                return;
            }

            const docPath = `artifacts/${appId}/public/data/soccer_stats/${docId}`;
            
            const updatedStats = {
                position: editPositionInput.value,
                goals: parseInt(editGoalsInput.value, 10) || 0,
                assists: parseInt(editAssistsInput.value, 10) || 0,
                games: parseInt(editGamesInput.value, 10) || 0,
                lastUpdated: new Date().toISOString(),
            };

            try {
                // Use updateDoc to modify specific fields
                await runWithRetry(() => updateDoc(doc(db, docPath), updatedStats), 'Update Player Stat');
                console.log("Document successfully updated!");
                editModal.classList.add('hidden');
            } catch (error) {
                console.error("Error updating player stats:", error);
                errorTextElement.textContent = `Failed to update player stats. ${error.message}`;
                errorElement.classList.remove('hidden');
            }
        });


        // --- Initialization ---
        initializeFirebase();
    </script>
</body>
</html>
